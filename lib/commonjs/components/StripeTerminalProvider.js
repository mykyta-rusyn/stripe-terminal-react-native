var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.StripeTerminalProvider=StripeTerminalProvider;var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _react=_interopRequireWildcard(require("react"));var _types=require("../types");var _StripeTerminalContext=require("./StripeTerminalContext");var _functions=require("../functions");var _useListener=require("../hooks/useListener");var _reactNative=require("react-native");var _EventEmitter=_interopRequireDefault(require("react-native/Libraries/vendor/emitter/EventEmitter"));var _jsxRuntime=require("react/jsx-runtime");var _jsxFileName="/Users/rmykyta/repos/stripe-terminal-react-native/src/components/StripeTerminalProvider.tsx";function _interopRequireWildcard(e,t){if("function"==typeof WeakMap)var r=new WeakMap(),n=new WeakMap();return(_interopRequireWildcard=function _interopRequireWildcard(e,t){if(!t&&e&&e.__esModule)return e;var o,i,f={__proto__:null,default:e};if(null===e||"object"!=typeof e&&"function"!=typeof e)return f;if(o=t?n:r){if(o.has(e))return o.get(e);o.set(e,f);}for(var _t in e)"default"!==_t&&{}.hasOwnProperty.call(e,_t)&&((i=(o=Object.defineProperty)&&Object.getOwnPropertyDescriptor(e,_t))&&(i.get||i.set)?o(f,_t,i):f[_t]=e[_t]);return f;})(e,t);}var _NativeModules$Stripe=_reactNative.NativeModules.StripeTerminalReactNative.getConstants(),FETCH_TOKEN_PROVIDER=_NativeModules$Stripe.FETCH_TOKEN_PROVIDER,CHANGE_CONNECTION_STATUS=_NativeModules$Stripe.CHANGE_CONNECTION_STATUS,CHANGE_PAYMENT_STATUS=_NativeModules$Stripe.CHANGE_PAYMENT_STATUS,FINISH_DISCOVERING_READERS=_NativeModules$Stripe.FINISH_DISCOVERING_READERS,FINISH_INSTALLING_UPDATE=_NativeModules$Stripe.FINISH_INSTALLING_UPDATE,REQUEST_READER_DISPLAY_MESSAGE=_NativeModules$Stripe.REQUEST_READER_DISPLAY_MESSAGE,REQUEST_READER_INPUT=_NativeModules$Stripe.REQUEST_READER_INPUT,REPORT_AVAILABLE_UPDATE=_NativeModules$Stripe.REPORT_AVAILABLE_UPDATE,REPORT_UPDATE_PROGRESS=_NativeModules$Stripe.REPORT_UPDATE_PROGRESS,START_INSTALLING_UPDATE=_NativeModules$Stripe.START_INSTALLING_UPDATE,UPDATE_DISCOVERED_READERS=_NativeModules$Stripe.UPDATE_DISCOVERED_READERS,START_READER_RECONNECT=_NativeModules$Stripe.START_READER_RECONNECT,READER_RECONNECT_SUCCEED=_NativeModules$Stripe.READER_RECONNECT_SUCCEED,READER_RECONNECT_FAIL=_NativeModules$Stripe.READER_RECONNECT_FAIL,CHANGE_OFFLINE_STATUS=_NativeModules$Stripe.CHANGE_OFFLINE_STATUS,FORWARD_PAYMENT_INTENT=_NativeModules$Stripe.FORWARD_PAYMENT_INTENT,REPORT_FORWARDING_ERROR=_NativeModules$Stripe.REPORT_FORWARDING_ERROR,DISCONNECT=_NativeModules$Stripe.DISCONNECT,UPDATE_BATTERY_LEVEL=_NativeModules$Stripe.UPDATE_BATTERY_LEVEL,REPORT_LOW_BATTERY_WARNING=_NativeModules$Stripe.REPORT_LOW_BATTERY_WARNING,REPORT_READER_EVENT=_NativeModules$Stripe.REPORT_READER_EVENT,ACCEPT_TERMS_OF_SERVICE=_NativeModules$Stripe.ACCEPT_TERMS_OF_SERVICE;var emitter=new _EventEmitter.default();var TOKEN_PROVIDER_ERROR_MESSAGE="Couldn't fetch connection token. Please check your tokenProvider method";function StripeTerminalProvider(_ref){var children=_ref.children,tokenProvider=_ref.tokenProvider,logLevel=_ref.logLevel;var isInitializedRef=(0,_react.useRef)(false);var getIsInitialized=(0,_react.useCallback)(function(){return isInitializedRef.current;},[]);var _useState=(0,_react.useState)(true),_useState2=(0,_slicedToArray2.default)(_useState,2),loading=_useState2[0],setLoading=_useState2[1];var _useState3=(0,_react.useState)(),_useState4=(0,_slicedToArray2.default)(_useState3,2),connectedReader=_useState4[0],setConnectedReader=_useState4[1];var _useState5=(0,_react.useState)([]),_useState6=(0,_slicedToArray2.default)(_useState5,2),discoveredReaders=_useState6[0],setDiscoveredReaders=_useState6[1];var log=(0,_react.useCallback)(function(code,message){if(logLevel==='verbose'){console.log(`[Stripe terminal]: ${code}`,message);}},[logLevel]);var didUpdateDiscoveredReaders=(0,_react.useCallback)(function(_ref2){var readers=_ref2.readers;log('didUpdateDiscoveredReaders',readers);emitter==null||emitter.emit(UPDATE_DISCOVERED_READERS,readers);},[log]);var didFinishDiscoveringReaders=(0,_react.useCallback)(function(_ref3){var result=_ref3.result;log('didFinishDiscoveringReaders',result);emitter==null||emitter.emit(FINISH_DISCOVERING_READERS,result.error);},[log]);var didReportAvailableUpdate=(0,_react.useCallback)(function(_ref4){var result=_ref4.result;log('didReportAvailableUpdate',result);emitter==null||emitter.emit(REPORT_AVAILABLE_UPDATE,result);},[log]);var didStartInstallingUpdate=(0,_react.useCallback)(function(_ref5){var result=_ref5.result;log('didStartInstallingUpdate',result);emitter==null||emitter.emit(START_INSTALLING_UPDATE,result);},[log]);var didReportReaderSoftwareUpdateProgress=(0,_react.useCallback)(function(_ref6){var result=_ref6.result;log('didReportReaderSoftwareUpdateProgress',result);emitter==null||emitter.emit(REPORT_UPDATE_PROGRESS,result.progress);},[log]);var didFinishInstallingUpdate=(0,_react.useCallback)(function(_ref7){var result=_ref7.result;log('didFinishInstallingUpdate',result);emitter==null||emitter.emit(FINISH_INSTALLING_UPDATE,result);},[log]);var didRequestReaderInput=(0,_react.useCallback)(function(_ref8){var result=_ref8.result;log('didRequestReaderInput',result);emitter==null||emitter.emit(REQUEST_READER_INPUT,result);},[log]);var didRequestReaderDisplayMessage=(0,_react.useCallback)(function(_ref9){var result=_ref9.result;log('didRequestReaderDisplayMessage',result);emitter==null||emitter.emit(REQUEST_READER_DISPLAY_MESSAGE,result);},[log]);var didChangePaymentStatus=(0,_react.useCallback)(function(_ref0){var result=_ref0.result;log('didChangePaymentStatus',result);emitter==null||emitter.emit(CHANGE_PAYMENT_STATUS,result);},[log]);var didChangeConnectionStatus=(0,_react.useCallback)(function(_ref1){var result=_ref1.result;log('didChangeConnectionStatus',result);emitter==null||emitter.emit(CHANGE_CONNECTION_STATUS,result);},[log]);var didStartReaderReconnect=(0,_react.useCallback)(function(_ref10){var reason=_ref10.reason;log('didStartReaderReconnect',reason);emitter==null||emitter.emit(START_READER_RECONNECT,reason);},[log]);var didSucceedReaderReconnect=(0,_react.useCallback)(function(_ref11){var reader=_ref11.reader;log('didSucceedReaderReconnect');emitter==null||emitter.emit(READER_RECONNECT_SUCCEED,reader);},[log]);var didFailReaderReconnect=(0,_react.useCallback)(function(_ref12){var error=_ref12.error;log('didFailReaderReconnect');emitter==null||emitter.emit(READER_RECONNECT_FAIL,error);},[log]);var didChangeOfflineStatus=(0,_react.useCallback)(function(_ref13){var result=_ref13.result;log('didChangeOfflineStatus',result);emitter==null||emitter.emit(CHANGE_OFFLINE_STATUS,result);},[log]);var didForwardPaymentIntent=(0,_react.useCallback)(function(_ref14){var result=_ref14.result,error=_ref14.error;log('didForwardPaymentIntent',Object.assign({},result,error));emitter==null||emitter.emit(FORWARD_PAYMENT_INTENT,result,error);},[log]);var didReportForwardingError=(0,_react.useCallback)(function(_ref15){var error=_ref15.error;log('didReportForwardingError',error);emitter==null||emitter.emit(REPORT_FORWARDING_ERROR,error);},[log]);var didDisconnect=(0,_react.useCallback)(function(_ref16){var reason=_ref16.reason;log('didDisconnect',reason);emitter==null||emitter.emit(DISCONNECT,reason);},[log]);var didUpdateBatteryLevel=(0,_react.useCallback)(function(_ref17){var result=_ref17.result;log('didUpdateBatteryLevel',result);emitter==null||emitter.emit(UPDATE_BATTERY_LEVEL,result);},[log]);var didReportLowBatteryWarning=(0,_react.useCallback)(function(_ref18){var result=_ref18.result;log('didReportLowBatteryWarning',result);emitter==null||emitter.emit(REPORT_LOW_BATTERY_WARNING,result);},[log]);var didReportReaderEvent=(0,_react.useCallback)(function(_ref19){var result=_ref19.result;log('didReportReaderEvent',result);emitter==null||emitter.emit(REPORT_READER_EVENT,result);},[log]);var didAcceptTermsOfService=(0,_react.useCallback)(function(){log('didAcceptTermsOfService');emitter==null||emitter.emit(ACCEPT_TERMS_OF_SERVICE);},[log]);(0,_useListener.useListener)(REPORT_AVAILABLE_UPDATE,didReportAvailableUpdate);(0,_useListener.useListener)(START_INSTALLING_UPDATE,didStartInstallingUpdate);(0,_useListener.useListener)(REPORT_UPDATE_PROGRESS,didReportReaderSoftwareUpdateProgress);(0,_useListener.useListener)(FINISH_INSTALLING_UPDATE,didFinishInstallingUpdate);(0,_useListener.useListener)(UPDATE_DISCOVERED_READERS,didUpdateDiscoveredReaders);(0,_useListener.useListener)(FINISH_DISCOVERING_READERS,didFinishDiscoveringReaders);(0,_useListener.useListener)(REQUEST_READER_INPUT,didRequestReaderInput);(0,_useListener.useListener)(REQUEST_READER_DISPLAY_MESSAGE,didRequestReaderDisplayMessage);(0,_useListener.useListener)(CHANGE_PAYMENT_STATUS,didChangePaymentStatus);(0,_useListener.useListener)(CHANGE_CONNECTION_STATUS,didChangeConnectionStatus);(0,_useListener.useListener)(START_READER_RECONNECT,didStartReaderReconnect);(0,_useListener.useListener)(READER_RECONNECT_SUCCEED,didSucceedReaderReconnect);(0,_useListener.useListener)(READER_RECONNECT_FAIL,didFailReaderReconnect);(0,_useListener.useListener)(CHANGE_OFFLINE_STATUS,didChangeOfflineStatus);(0,_useListener.useListener)(FORWARD_PAYMENT_INTENT,didForwardPaymentIntent);(0,_useListener.useListener)(REPORT_FORWARDING_ERROR,didReportForwardingError);(0,_useListener.useListener)(DISCONNECT,didDisconnect);(0,_useListener.useListener)(UPDATE_BATTERY_LEVEL,didUpdateBatteryLevel);(0,_useListener.useListener)(REPORT_LOW_BATTERY_WARNING,didReportLowBatteryWarning);(0,_useListener.useListener)(REPORT_READER_EVENT,didReportReaderEvent);(0,_useListener.useListener)(ACCEPT_TERMS_OF_SERVICE,didAcceptTermsOfService);var tokenProviderHandler=function(){var _ref21=(0,_asyncToGenerator2.default)(function*(_ref20){var callbackId=_ref20.callbackId;try{var connectionToken=yield tokenProvider();(0,_functions.setConnectionToken)(connectionToken,undefined,callbackId);}catch(error){(0,_functions.setConnectionToken)(undefined,TOKEN_PROVIDER_ERROR_MESSAGE,callbackId);console.error(error);console.error(TOKEN_PROVIDER_ERROR_MESSAGE);}});return function tokenProviderHandler(_x){return _ref21.apply(this,arguments);};}();(0,_useListener.useListener)(FETCH_TOKEN_PROVIDER,tokenProviderHandler);var _initialize=(0,_react.useCallback)((0,_asyncToGenerator2.default)(function*(){setLoading(true);try{yield tokenProvider();}catch(error){console.error(TOKEN_PROVIDER_ERROR_MESSAGE);console.error(error);return{error:{code:_types.CommonError.Failed,message:TOKEN_PROVIDER_ERROR_MESSAGE}};}var response=yield(0,_functions.initialize)({logLevel:logLevel});if(response.error){log(response.error.code,response.error.message);}else if(response.reader){log('Connected to the reader: ',response.reader);setConnectedReader(response.reader);}if(!response.error){isInitializedRef.current=true;}setLoading(false);return response;}),[logLevel,tokenProvider,log]);var value=(0,_react.useMemo)(function(){return{loading:loading,isInitialized:isInitializedRef.current,getIsInitialized:getIsInitialized,connectedReader:connectedReader,discoveredReaders:discoveredReaders,setLoading:setLoading,setConnectedReader:setConnectedReader,setDiscoveredReaders:setDiscoveredReaders,log:log,initialize:_initialize,emitter:emitter};},[_initialize,loading,getIsInitialized,connectedReader,discoveredReaders,setLoading,setConnectedReader,setDiscoveredReaders,log]);return(0,_jsxRuntime.jsx)(_StripeTerminalContext.StripeTerminalContext.Provider,{value:value,children:children});}
//# sourceMappingURL=StripeTerminalProvider.js.map